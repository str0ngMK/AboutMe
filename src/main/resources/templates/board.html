<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
    <link rel="stylesheet" type="text/css" href="/css/nav.css" />
</head>
<style>
	.content p{
		word-wrap: break-word;
	}
	.content p img {
		width: 100%;
	}

	.board_img{
		max-width: 100%;
		max-height: 100%;
	}
	blockquote {
		display:block;
		background: #fff;
		padding: 15px 20px 15px 45px;
		margin: 0 0 20px;
		position: relative;
		
		/*Font*/
		font-family: Georgia, serif;
		font-size: 14px;
		line-height: 1.2;
		color: #666;
		
		/*Box Shadow - (Optional)*/
		-moz-box-shadow: 2px 2px 15px #ccc;
		-webkit-box-shadow: 2px 2px 15px #ccc;
		box-shadow: 2px 2px 15px #ccc;
		
		/*Borders - (Optional)*/
		border-left-style: solid;
		border-left-width: 15px;
		border-right-style: solid;
		border-right-width: 2px;

		/* color */
		border-left-color: #ccd1d8;
  		border-right-color: #aab2bc;
	}

	blockquote::before {
		/*Font*/
		font-family: Georgia, serif;
		font-size: 60px;
		font-weight: bold;
		color: #999;
		
		/*Positioning*/
		position: absolute;
		left: 10px;
		top:5px;
	}

	blockquote p {
		margin: auto;
	}

</style>
<body>
	<nav th:replace="~{nav/nav :: nav}"></nav>
	<div class="modal" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
		<!-- <div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
			  <div class="modal-header">
				<h1 class="modal-title" id="deleteModalLabel">안내</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			  </div>
			  <div class="modal-body">
				  <p>
					삭제 하시겠습니까?
				  </p>
			  </div>
			  <div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
				<button type="button" class="btn btn-primary" onclick="pwdValidity()">확인</button>
			  </div>
			</div>
		</div> -->
	</div>
	<div class="modal" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3" id="pwd-box">
                        <label for="pwd-value" class="col-form-label">비밀번호:</label>
                        <input type="password" class="form-control" id="pwd-value" aria-label="2" ria-describedby="test02">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
              <button type="button" class="btn btn-primary" onclick="pwdValidity()">확인</button>
            </div>
          </div>
        </div>
    </div>
	<div class="container" id="board">
	</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/3.0.7/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
<script type="text/javascript">
	const modal = new bootstrap.Modal(document.getElementById('exampleModal'));
	const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

	const urlParams = new URLSearchParams(window.location.search);
    const no = urlParams.get('no');

	marked.setOptions({
		breaks: true, // 줄바꿈을 <br>로 변환
		highlight: function (code, lang) {
		if (lang && hljs.getLanguage(lang)) {
			return hljs.highlight(lang, code).value;
		}
		return hljs.highlightAuto(code).value;
		}
	});

	window.onload = function() {
    	getBoard();
    }

	function getBoard() {
		fetch("/board/get?no=" + no)
        .then((response) => {
			if(response.ok){
				return response.json();
			}
			window.location.href = "/error";
        })
        .then((data) => {
			document.title = data.title;

			const board = document.getElementById('board');

			createTitle(data.title, board);
			createAuthorAndDate(data, board);
			createContent(data.content, data.image, board);

			document.querySelectorAll('.content pre').forEach((block) => {
				console.log('block: ', block);
			hljs.highlightBlock(block);
		});
		})
		.catch((error) => {
          	console.error("Error:", error);
        });
	}

	function createTitle(dataTitle, board){
		let row = document.createElement('div');
		row.className = 'row';

		let col = document.createElement('div');
		col.className = 'col';

		let title = document.createElement('p');
		title.textContent = dataTitle;

		col.appendChild(title);
		row.appendChild(col);
		board.appendChild(row);
	}

	function createAuthorAndDate(data, board){
		const insDateTime = new Date(data.insDate);
		const insYear = insDateTime.getFullYear();
		let insMonth = dateFmtConverter(insDateTime.getMonth() + 1);
		let insDay = dateFmtConverter(insDateTime.getDate());
		let insHour = dateFmtConverter(insDateTime.getHours());
		let insMinute = dateFmtConverter(insDateTime.getMinutes());
		
		const updDateTime = new Date(data.updDate);
		const updYear = updDateTime.getFullYear();
		let updMonth = dateFmtConverter(updDateTime.getMonth() + 1);
		let updDay = dateFmtConverter(updDateTime.getDate());
		let updHour = dateFmtConverter(updDateTime.getHours());
		let updMinute = dateFmtConverter(updDateTime.getMinutes());

		let row = document.createElement('div');
		row.className = 'row';

		let authorCol = document.createElement('div');
		authorCol.className = 'col-md-9';

		let groupCol = document.createElement('div');
		groupCol.className = 'col';

		let insDateRow = document.createElement('div');
		insDateRow.className = 'row';

		let insDateCol = document.createElement('div');
		insDateCol.className = 'col';

		let updDateRow = document.createElement('div');
		updDateRow.className = 'row';

		let updDateCol = document.createElement('div');
		updDateCol.className = 'col';

		let btnRow = document.createElement('div');
		btnRow.className = 'row';

		let btnCol = document.createElement('div');
		btnCol.className = 'col justify-content-end';
		btnCol.style.display = 'flex';

		let author = document.createElement('small');
		author.textContent = data.author;

		let insDate = document.createElement('small');
		insDate.textContent = '작성일 ' + insYear + "." + insMonth + "." + insDay + " " + insHour + ":" + insMinute;
		insDate.style.whiteSpace = 'nowrap';

		let updDate = document.createElement('small');
		updDate.textContent = '마지막 수정일 ' + updYear + "." + updMonth + "." + updDay + " " + updHour + ":" + updMinute;
		updDate.style.whiteSpace = 'nowrap';

		let modifyBtn = document.createElement('button');
		modifyBtn.className = 'btn btn-outline-secondary h-75';
		modifyBtn.textContent = '수정';
		modifyBtn.style.display = 'flex';
		modifyBtn.style.alignItems = 'center';
		modifyBtn.onclick = function() {
			// window.location.href = "/modify?no=" + no;
			document.getElementById('exampleModalLabel').textContent = '수정 하기';
			modal.show();
			document.getElementById('pwd-value').focus();
		}
		
		let deleteBtn = document.createElement('button');
		deleteBtn.className = 'btn btn-outline-secondary h-75';
		deleteBtn.textContent = '삭제';
		deleteBtn.style.display = 'flex';
		deleteBtn.style.alignItems = 'center';
		deleteBtn.onclick = function(){
			document.getElementById('exampleModalLabel').textContent = '삭제 하기';
            modal.show();
			document.getElementById('pwd-value').focus();
		}

		let hr = document.createElement('hr');

		insDateCol.appendChild(insDate);
		insDateRow.appendChild(insDateCol);

		updDateCol.appendChild(updDate);
		updDateRow.appendChild(updDateCol);

		btnCol.appendChild(modifyBtn);
		btnCol.appendChild(deleteBtn);
		btnRow.appendChild(btnCol);

		groupCol.appendChild(insDateRow);
		groupCol.appendChild(updDateRow);
		groupCol.appendChild(btnRow);
		authorCol.appendChild(author);
		
		row.appendChild(authorCol);
		row.appendChild(groupCol);
		row.appendChild(hr);

		board.appendChild(row);
	}

	function pwdValidity(){
		let type;

		if(document.getElementById('exampleModalLabel').innerText === '수정 하기') {
			type = 'M';

		} else {
			type = 'D';
		}

		const pwd = document.getElementById('pwd-value').value;

		if (pwd.length < 1 || /^\s*$/.test(pwd)) {
            const pwdBox = document.getElementById('pwd-box');

			if(!pwdBox.querySelector('#test02')){
				const feedback = document.createElement('div');
				feedback.id = 'test02';
				feedback.className = 'invalid-feedback';
				feedback.textContent = '1~16자 입력';
				
				const pwdValue = document.getElementById('pwd-value');
				pwdValue.className = 'form-control is-invalid';

				pwdBox.appendChild(feedback);
			}
        } else {
			findPwd(pwd, type);
		}
	}

	function findPwd(pwd, type){
		const formData = { no : no, boardPwd : pwd };
		fetch("/board/pwdCheck", {
            method : 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
			body : JSON.stringify(formData),
        })
        .then((response) => {
            if(response.ok){
                return response.json();
            }
            window.location.href = "/error";
        })
        .then((data) => {
			modal.hide();
			if (data) {
				// const modal = new bootstrap.Modal(document.getElementById('exampleModal'));
				if (type === 'D'){
					const modal = document.getElementById('deleteModal');

					let modalDialog = document.createElement('div');
					modalDialog.className = 'modal-dialog modal-dialog-centered';

					let modalContent = document.createElement('div');
					modalContent.className = 'modal-content';

					let modalHeader = document.createElement('div');
					modalHeader.className = 'modal-header';

					let modalTitle = document.createElement('h5');
					modalTitle.className = 'modal-title';
					modalTitle.id = 'deleteModalLabel';
					modalTitle.textContent = '안내';

					let btnClose = document.createElement('button');
					btnClose.type = 'button';
					btnClose.className = 'btn-close';
					btnClose.setAttribute('data-bs-dismiss', 'modal');
					btnClose.setAttribute('aria-label', 'Close');

					let modalBody = document.createElement('div');
					modalBody.className = 'modal-body';

					let p = document.createElement('p');
					p.textContent = '삭제 하시겠습니까?';

					let modalFooter = document.createElement('div');
					modalFooter.className = 'modal-footer';

					let btnCancel = document.createElement('button');
					btnCancel.type = 'button';
					btnCancel.className = 'btn btn-secondary';
					btnCancel.setAttribute('data-bs-dismiss', 'modal');
					btnCancel.textContent = '취소';

					let btnSubmit = document.createElement('button');
					btnSubmit.type = 'button';
					btnSubmit.className = 'btn btn-primary';
					btnSubmit.onclick = function() {
						deleteBoard(pwd);
					};
					btnSubmit.textContent = '확인';

					modalHeader.appendChild(modalTitle);
					modalHeader.appendChild(btnClose);

					modalBody.appendChild(p);

					modalFooter.appendChild(btnCancel);
					modalFooter.appendChild(btnSubmit);

					modalContent.appendChild(modalHeader);
					modalContent.appendChild(modalBody);
					modalContent.appendChild(modalFooter);

					modalDialog.appendChild(modalContent);

					modal.appendChild(modalDialog);

					const btModal = new bootstrap.Modal(modal);
					btModal.show();
				} else {
					window.location.href = "/board/modify?no=" + no;
				}
			} else {
				alert('비밀번호를 확인 해 주세요.');
			}
        })
        .catch((error) => {
            console.error("Error:", error);
        });
	}

	function modifyBoard(pwd){
		const formData = { no : no, boardPwd : pwd };

		fetch("/board/modify", {
			method : 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body : JSON.stringify(formData),
		})
		.then((response) => {
			if(response.ok){
				return response.json();
			}
			window.location.href = "/error";
		})
		.then((data) => {


		})
		.catch((error) => {

		});
	}

	function deleteBoard(pwd){
		// const formData = { no : no, boardPwd : pwd };

		fetch("/board/delete" ,{
            method : 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
			// body : JSON.stringify(formData),
        })
        .then((response) => {
            if(response.ok){
                return response.json();
            }
            window.location.href = "/error";
        })
        .then((data) => {
			if(data.result){
				window.location.href = "/board/list";
			} else {
				deleteModal.hide();
				alert(data.message);
			}
		})
		.catch((error) => {

		});
	}

	function createContent(dataContent, dataImage, board) {
		let row = document.createElement('div');
		row.className = 'row';
		
		let col = document.createElement('div');
		col.className = 'col';
		
		let div = document.createElement('div');
		div.className = 'content';

		// if (dataImage.length > 0) {
		// 	dataImage.forEach(img => {
		// 		let contentImg = '<' + img + '>';
		// 		let imgTag = '<img src="/file/' + img + '" class="board_img"/>';

		// 		dataContent = dataContent.replace(contentImg, imgTag);
		// 	})
		// }

		const htmlContent = marked(dataContent);
		div.innerHTML = htmlContent;
		col.appendChild(div);
		row.appendChild(col);
		board.appendChild(row);
	}

	function dateFmtConverter(element){
		if (element < 10) {
			element = '0' + element;
		}
		return element;
	}
</script>
</html>